<!DOCTYPE html>
<html>
	<head>
  		<meta charset="utf-8">
  		<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
	  	<meta name="apple-mobile-web-app-capable" content="yes">
  		<meta name="apple-mobile-web-app-status-bar-style" content="black">
  		<title>SUA UNAD</title>
  		<link rel="stylesheet" href="css/index.css?7">
  		<!-- Extra Codiqa features -->
  		<script src="js/jquery-1.9.1.min.js"></script>
  		<script src="bootstrap-3.3.5-dist/js/bootstrap.min.js"></script>
  		<script type="text/javascript" src="js/underscore-min.js"></script>
  		<script type="text/javascript" src="js/moment.min.js"></script>
  		<script type="text/javascript" src="js/readable-range.js"></script>
  		<script type="text/javascript" src="js/indexeddbshim.min.js"></script>
  		<script type="text/javascript" src="js/pouchdb-4.0.0.min.js"></script>
  		<script type="text/javascript" src="js/momentJS_espanol.js"></script>
  		<script type="text/javascript" src="js/accounting.min.js"></script>
  		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="bootstrap-3.3.5-dist/css/bootstrap.min.css">
		<!-- Latest compiled and minified JavaScript -->
		
		<style>
			#cuerpoActividades .actividad{
				margin: 2em 0;
				padding: 8px 4px;
				border: 1.5px solid #DDA877;
			}
			#cuerpoActividades .actividad[tachado="1"] div{
				display: none;
			}
			#cuerpoActividades .actividad[tachado="1"] .titulo{
				display: inherit!important;
				text-decoration: line-through;
			}
			#cuerpoActividades .actividad[tachado="1"] .calificacion,
			#cuerpoActividades .actividad[tachado="1"] .ultComen{
				display: inherit!important;
			}
			#cuerpoActividades .actividad .titulo{
				background: #f3f3f3;
				border-bottom: 1px solid #cccccc;
				font-weight: bold;
				text-align:center;
			}
			#cuerpoActividades .actividad .tiempoCierre{
				color: white;
				margin-top:10px;
				text-align: center;
			}
			#cuerpoActividades .actividad .descripcion{
				border:1px solid #ccc;
				margin-bottom:3px;
				margin-top:3px;
				padding:5px;
			}
			#cuerpoActividades .actividad .menuAct{
				display: inherit!important;
				font-size: 1.5em;
				padding:5px;
				position: relative;
			}
			#cuerpoActividades .actividad .menuAct .opciones{
				display: inherit!important;
				font-size: 1.5rem;
				background: white;
				border-radius: 0 0 8px 8px;
				border: 1px solid #ccc;
			  	box-shadow: -5px 0px 7px #ccc;
			  	-moz-box-shadow: -5px 0px 7px #ccc;
			  	-webkit-box-shadow: -5px 0px 7px #ccc;
				padding: 7px;
			    position: absolute;
			    text-align: right;
    			right: 5px;
    			top: 1.5em;
    			z-index: 2;
			}
			#cuerpoActividades .actividad .menuAct .opciones .opcion{
				display: inherit!important;
				padding: 10px 17px;
				border-bottom: 1px solid #ccc;
			}
			#cuerpoActividades .actividad .tiempoCierre[cierre="1"]{
				background: #095509;
			}
			#cuerpoActividades .actividad .tiempoCierre[cierre="0"]{
				background: black;
			}
			#cuerpoActividades .actividad .tiempoCierre[cierre="2"]{
				background: orange;
			}
			#cuerpoActividades .actividad .tiempoCierre[cierre="3"]{
				background: #A50000;
			}
			#Cortina{
				background: rgba(255, 255, 255, 0.58);
				left:0;
				font-size: 2em;
				position:absolute;
				text-align: center;
				font-weight: bold;
				top:0;
				z-index: 9999;
			}
			#Cortina[st="0"]{
				display: none;
				height:0;
				margin : 0;
				overflow: hidden;
				padding:0 ;
				width:0;
			}
			#Cortina[st="1"]{
				display: ;
				height:100%;
				margin : 0;
				overflow: hidden;
				padding:5em 1em;
				width:100%;
			}
		</style>
	</head>
	<body style="padding-top: 60px;">
		<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
			<div class="navbar-header">
		    	<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex6-collapse">
		        	<span class="sr-only">Menu</span>
		        	<span class="icon-bar"></span>
		        	<span class="icon-bar"></span>
		        	<span class="icon-bar"></span>
		      	</button>
	      		<a class="navbar-brand" href="#">SUA UNAD</a>
	    	</div>
		    <!-- Collect the nav links, forms, and other content for toggling -->
		    <div class="collapse navbar-collapse navbar-ex6-collapse">
		    	<ul class="nav navbar-nav">
		        	<li class="active enviarRecibir"><a href="#">Sincronizar</a></li>
		        	<li class="active" style="display: none;" onclick="window.location.reload()"><a href="#">Recargar</a></li>
		        	<li class="active configurar"><a href="#">Configurar</a></li>
		        	<li class="active borrarBD"><a href="#">Limpiar BD</a></li>
		        	<li class="active" onclick="$('#modalAyuda').modal();"><a href="#">Ayuda</a></li>
		      	</ul>
	    	</div><!-- /.navbar-collapse -->
  		</nav>
 		<div id="cuerpoActividades" class="col-sm-12" style="padding-bottom: 60px;"></div>
		<nav class="navbar navbar-default navbar-fixed-bottom" role="navigation">
			<div class="navbar-header">
		    	<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex7-collapse">
		        	<span class="sr-only">Menu 2</span>
		        	<span class="icon-bar"></span>
		        	<span class="icon-bar"></span>
		        	<span class="icon-bar"></span>
		      	</button>
	      		<a class="navbar-brand" href="#">Herramientas</a>
	    	</div>
		    <!-- Collect the nav links, forms, and other content for toggling -->
		    <div class="collapse navbar-collapse navbar-ex7-collapse">
		    	<ul class="nav navbar-nav">
		        	<li class="active actCerradas"><a href="#">Actividades Cerradas</a></li>
		        	<li class="active actSinCerrar"><a href="#">Actividades Sin Cerrar</a></li>
		        	<li class="active actTodas"><a href="#">Todas las Actividades</a></li>
		      	</ul>
	    	</div><!-- /.navbar-collapse -->
  		</nav>
  		<div id="Cortina">CARGANDO</div>
  		<div class="modal fade" id="modalAyuda">
		  	<div class="modal-dialog">
			    <div class="modal-content">
			      	<div class="modal-header">
		        		<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		        		<h4 class="modal-title">Bienvedido a SUA UNAD</h4>
	      			</div>
		      		<div class="modal-body">
		        		<p>SUA UNAD es una aplicacion desarrollada para la gesti&oacute;n de actividades acad&eacute;micas.</p>
		        		<p>SUA UNAD tiene las siguientes opciones:</p>
		        		<ul>
		        			<li>
		        				<b>Menú Superior(SUA UNAD):</b> En el encontraras opciones generales como:
		        				<ul>
		        					<li>Sincronizar: Sincroniza la app con la base de datos dela UNAD. Recomdable hacerlo una vez a la semana.</il>
		        					<li>Recargar: Actualizara la app.</il>
		        				</ul>
		        				<b>Menú Inferior(HERRAMIENTAS):</b> En el encontrara herramientas como:
		        				<ul>
		        					<li>Actividades Cerradas: Todas las actividades que ya han sido cerradas.</il>
		        					<li>Actividades Sin Cerrar: Todas las actividades que a&uacute;n no han sido cerradas.</il>
		        					<li>Todas las Actividades: Todas las actividades cerradas y no cerradas.</il>
		        				</ul>
		        			</il>
		        		</ul>
		        		<div style="font-weight: bold;font-size: 0.9em; margin:15px 0; text-align: right;" >
		        			Desarrollada por oscarricardosan@gmail.com
		        		</div>
		      		</div>
		      		<div class="modal-footer">
		        		<button type="button" class="btn btn-default" data-dismiss="modal">Entendido</button>
		      		</div>
		    	</div><!-- /.modal-content -->
		  	</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
		<div class="modal fade" id="modalLog">
		  	<div class="modal-dialog">
			    <div class="modal-content">
			      	<div class="modal-header">
		        		<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		        		<h4 class="modal-title">Log</h4>
	      			</div>
		      		<div class="modal-body">
		        		<div class="cuerpo" ></div>
		      		</div>
		      		<div class="modal-footer">
		        		<button type="button" class="btn btn-default" data-dismiss="modal">Salir</button>
		      		</div>
		    	</div><!-- /.modal-content -->
		  	</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
		
		<div class="modal fade" id="modalConfiguracion">
		  	<div class="modal-dialog">
			    <div class="modal-content">
			      	<div class="modal-header">
		        		<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		        		<h4 class="modal-title">Configuracion</h4>
	      			</div>
		      		<div class="modal-body">
		      			<p>
		      				Los datos suministrados en ning&uacute;n momento ser&aacute;n entregados y/o usados por terceros. 
							Son datos que habilitan la funcionalidad de almacenar comentarios, notas y dem&aacute;s.
		      			</p>
		        		<div class="form-group">
					    	<label>Documento de Identidad (cedula, tarjeta de identidad, etc..)</label>
					    	<input class="form-control" id="idUsu">
					  	</div>
					  	<div class="form-group">
					    	<label>Nombre de usuario UNAD</label>
					    	<input class="form-control" id="nomUnad">
					  	</div>		
					  	<div class="form-group">
					    	<label>Nombre para mostrar</label>
					    	<input class="form-control" id="nombre">
					  	</div>	

		      		</div>
		      		<div class="modal-footer">
		      			<button type="button" class="btn btn-default guardar" data-dismiss="modal">Guardar</button>
		        		<button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
		      		</div>
		    	</div><!-- /.modal-content -->
		  	</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
		<div class="modal fade" id="modalNota">
		  	<div class="modal-dialog">
			    <div class="modal-content">
			      	<div class="modal-header">
		        		<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		        		<h4 class="modal-title">Nota</h4>
	      			</div>
		      		<div class="modal-body">
		        		<div class="form-group">
					    	<label>Nota de la actividad</label>
				    		<input class="form-control" id="nuevaNota">
				    		<label>Sobre <span class="notaTotal"></span></label>
					  	</div>	
		      		</div>
		      		<div class="modal-footer">
		      			<button type="button" class="btn btn-default guardar" data-dismiss="modal">Guardar</button>
		        		<button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
		      		</div>
		    	</div><!-- /.modal-content -->
		  	</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
		<div class="modal fade" id="modalComentario">
		  	<div class="modal-dialog">
			    <div class="modal-content">
			      	<div class="modal-header">
		        		<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		        		<h4 class="modal-title">Comentarios</h4>
	      			</div>
		      		<div class="modal-body">
		        		<div class="form-group">
					    	<label>Ingrese Comentario</label>
					    	<textArea class="form-control" id="comentario"></textArea>
					  	</div>	
					  	<div class="historico" style="height: 20em; overflow: auto"></div>	
		      		</div>
		      		<div class="modal-footer">
		      			<button type="button" class="btn btn-default guardar" data-dismiss="modal">Registrar Nuevo Comentario</button>
		        		<button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
		      		</div>
		    	</div><!-- /.modal-content -->
		  	</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
		<script type="">
			$(document).ready(function(){
				var FORM={
					dataPrin:{}
				};
				var nameDB = 'SUA_UNAD';
				var db = new PouchDB(nameDB);
				var remoteCouch = false;
				var utilidades = {
					abreCargador:function(){$('#Cortina').attr('st','1')},
					cierraCargador:function(){$('#Cortina').attr('st','0')},
					log_: function(msg){$('#modalLog .cuerpo').append(msg);}
				}
				utilidades.log_('Utilidades cargadas.<br>');
				$('li.configurar').click(function(){
					utilidades.cierraCargador();
					$('#modalConfiguracion').modal();
					db.get('dataPersonal').then(function(doc) {
						doc=validaDataPersonal(doc, 0);
						if(typeof(doc.cuerpo.dataUsu)=='undefined')return false;
						$('#modalConfiguracion #nomUnad').val(doc.cuerpo.dataUsu.nomUnad);
						$('#modalConfiguracion #nombre').val(doc.cuerpo.dataUsu.nomUsu);
						$('#modalConfiguracion #idUsu').val(doc.cuerpo.dataUsu.idUsu);
					}).then(function(response) {
						utilidades.log_('dataP obtenida.<br>');
					})
					.catch(function (err) {alert(err);})
				});
				$('#modalConfiguracion .guardar').click(function(event){
					event.preventDefault();
					db.get('dataPersonal').then(function(doc) {
						utilidades.log_('dataP obtenida.<br>');
						if(doc.cuerpo==undefined)doc.cuerpo={};
						doc.cuerpo.dataUsu={
							nomUsu:$('#modalConfiguracion #nombre').val(),
							idUsu:$('#modalConfiguracion #idUsu').val(),
							nomUnad:$('#modalConfiguracion #nomUnad').val(),
						};
					  	return db.put({
							_id:'dataPersonal',
							_rev: doc._rev,
							cuerpo:doc.cuerpo
						});
					}).then(function(response) {
						utilidades.log_('Se guarda data.<br>');
						alert('Datos Guardados');
						cargarVariablesDesdeDB();
						cargarActividadesOrderFecha();
					})
					.catch(function (err) {alert(err);})
				});
				$('#modalNota .guardar').click(function(event){
					var idAct = FORM.idActActual;
					var nuevaNota = $('#modalNota #nuevaNota').val();
					var notaTot = $('#modalNota .notaTotal').text();
					db.get('dataPersonal').then(function(doc) {
						if(validaDataPersonal(doc)==false)return false;
						doc=validaDataPersonal(doc);
						var idUsu = doc.cuerpo.dataUsu.idUsu;
						var nomUsu = doc.cuerpo.dataUsu.nomUsu;
						db.get('dataAdicional').then(function(docAd) {
							docAd = validaDataAdicional(docAd, idUsu,idAct);
							docAd.cuerpo[idUsu].acts[idAct].notaObtenida=nuevaNota;
							docAd.cuerpo[idUsu].acts[idAct].comentario.push({
								fechaRegISO:moment().format('YYYY-MM-DD HH:mm'),
								fechaRegInteger:moment().format('YYYYMMDDHHmm'),
								comen:nomUsu+': nota actualizada a '+nuevaNota+'.'	
							});
						  	return db.put({
								_id:'dataAdicional',
								_rev: docAd._rev,
								cuerpo:docAd.cuerpo
							});
						}).then(function(response) {
							cargarVariablesDesdeDB();
						})
						.catch(function (err) {alert(err);});
					})
					.catch(function (err) {alert(err);})
				});
				$('#modalComentario .guardar').click(function(event){
					var idAct = FORM.idActActual;
					db.get('dataPersonal').then(function(doc) {
						if(validaDataPersonal(doc)==false)return false;
						doc=validaDataPersonal(doc);
						var idUsu = doc.cuerpo.dataUsu.idUsu;
						var nomUsu = doc.cuerpo.dataUsu.nomUsu;
						db.get('dataAdicional').then(function(docAd) {
							docAd = validaDataAdicional(docAd, idUsu,idAct);
							docAd.cuerpo[idUsu].acts[idAct].comentario.push({
								fechaRegISO:moment().format('YYYY-MM-DD HH:mm'),
								fechaRegInteger:moment().format('YYYYMMDDHHmm'),
								comen:nomUsu+': '+$('#modalComentario #comentario').val()	
							});
						  	return db.put({
								_id:'dataAdicional',
								_rev: docAd._rev,
								cuerpo:docAd.cuerpo
							});
						}).then(function(response) {
							$('#modalComentario #comentario').val('');
							$("#cuerpoActividades .actividad .menuAct .opciones .opcion[accion='2']").click();
							cargarVariablesDesdeDB();
						})
						.catch(function (err) {alert(err);});
					})
					.catch(function (err) {alert(err);})
				});
				$('li.borrarBD').click(function(){
					var r = confirm("Con esta accion va a eliminar la Base de Datos(BD).\nEsta seguro?, esta acción es irreversible.\nAceptar(Si)");
					if (r == true) {
					    db.destroy();
					    alert('Base de datos eliminada');
						window.location.reload();					    
					} 
				});
				$('li.verLog').click(function(){
					$('#modalLog').modal();
				});
				$('li.enviarRecibir').click(function(){
					utilidades.abreCargador();
					var idAct = FORM.idActActual;
					db.get('dataPersonal').then(function(doc) {
						if(validaDataPersonal(doc)==false)return false;
						doc=validaDataPersonal(doc);
						var idUsu = doc.cuerpo.dataUsu.idUsu;
						var nomUsu = doc.cuerpo.dataUsu.nomUsu;
						var nomUnad = doc.cuerpo.dataUsu.nomUnad;
						var claveUsu = prompt(nomUnad+" ingresa tu clave de la plataforma UNAD.");
						if($.trim(nomUnad)=='' || $.trim(claveUsu)==''){
							cargarVariablesDesdeDB();
							cargarActividadesOrderFecha();
							utilidades.cierraCargador();
							return false;
						}
						db.get('dataAdicional').then(function(docAd) {
							docAd = validaDataAdicional(docAd, idUsu);
							$.ajax({
								url: 'http://savne.net/apps_web/SUA/dataActivitis.php',
								dataType : 'jsonp',
								data:{idUsu:idUsu, nomUsu:nomUnad, claveUsu:claveUsu, tip:2, data:docAd},
								timeout: 60000,
								success: function(data) {
									utilidades.log_('Data cargada<br>');
									try{
										var miData = docAd.cuerpo[idUsu];
									}catch(e){
										miData=undefined;
									}
									docAd.cuerpo = data[1];
									nActs=0;
									for (var nActs in miData.acts){
										nActs++; 
									}
									if(nActs>0)
										docAd.cuerpo[idUsu]=miData;
									newDataCuerpo = docAd.cuerpo;
									db.get('dataAdicional').then(function(docAd) {
									  	return db.put({
											_id:'dataAdicional',
											_rev: docAd._rev,
											cuerpo:newDataCuerpo
										});
									}).then(function(response) {
										cargarVariablesDesdeDB();
										$.each(data[0][2], function( index, act ) {
											if(act.diaini<10)act.diaini='0'+act.diaini;
											if(act.diafin<10)act.diafin='0'+act.diafin;
											if(act.mesini<10)act.mesini='0'+act.mesini;
											if(act.mesfin<10)act.mesfin='0'+act.mesfin;
											if(act.agnoini<10)act.agnoini='0'+act.agnoini;
											if(act.agnofin<10)act.agnofin='0'+act.agnofin;
										  	act.fecIni = act.diaini+'/'+act.mesini+'/'+act.agnoini;
										  	act.fecFin = act.diafin+'/'+act.mesfin+'/'+act.agnofin;
										  	act.fecIniISO = act.agnoini+'-'+act.mesini+'-'+act.diaini;
										  	act.fecFinISO = act.agnofin+'-'+act.mesfin+'-'+act.diafin;
										  	act.fecIniNumeric = parseInt(act.agnoini+''+act.mesini+''+act.diaini);
										  	act.fecFinNumeric = parseInt(act.agnofin+''+act.mesfin+''+act.diafin);
										});
										db.get('dataUnad').then(function(doc) {
										  	return db.put({
												_id:'dataUnad',
												_rev: doc._rev,
												cuerpo:data
											});
										}).then(function(response) {
											alert('Sincronizacion Exitosa.');cargarVariablesDesdeDB();
											cargarActividadesOrderFecha();
											utilidades.cierraCargador(); 
										})
										.catch(function (err) {alert(err);});
									})
									.catch(function (err) {alert(err);});
								},
								error:function( jqXHR, textStatus ) {
				  					alert( "Request failed: " + textStatus );
				  					utilidades.cierraCargador();
								}
							});
						})
						.catch(function (err) {alert(err);});
					})
					.catch(function (err) {alert(err);})
				});
				$('li.actCerradas').click(function(){
					$('#cuerpoActividades .actividad').css('display','none');
					$('#cuerpoActividades .actividad .tiempoCierre[cierre="0"]').parent().css('display','');
				});
				$('li.actSinCerrar').click(function(){
					$('#cuerpoActividades .actividad').css('display','none');
					$('#cuerpoActividades .actividad .tiempoCierre[cierre="1"]').parent().css('display','');
					$('#cuerpoActividades .actividad .tiempoCierre[cierre="2"]').parent().css('display','');
					$('#cuerpoActividades .actividad .tiempoCierre[cierre="3"]').parent().css('display','');
				});
				$('li.actTodas').click(function(){
					$('#cuerpoActividades .actividad').css('display','');
				});
				$("#cuerpoActividades").on("click",".actividad .menuAct", function() {
					if($(this).find('.opciones').length==0){
						$('#cuerpoActividades .actividad .menuAct').html('');
						$(this).html(
							'<div class="opciones">'+
							'<div class="opcion" accion="1">Tachar</div>'+
							'<div class="opcion" accion="4">Quitar_Tachado</div>'+
							'<div class="opcion" accion="2">Comentarios</div>'+
							'<div class="opcion" accion="3">Nota</div>'+
							'</div>'
						);
					}else $('#cuerpoActividades .actividad .menuAct').html('');
				});	
				$("#cuerpoActividades").on("click",".actividad .menuAct .opciones .opcion[accion='1']", function() {
					var elementAct = this;
					var elementActPadre = $(elementAct).closest( ".actividad" );
					var idAct = $(elementActPadre).attr('id');
					db.get('dataPersonal').then(function(doc) {
						if(validaDataPersonal(doc)==false)return false;
						doc=validaDataPersonal(doc);
						var idUsu = doc.cuerpo.dataUsu.idUsu;
						var nomUsu = doc.cuerpo.dataUsu.nomUsu;
						db.get('dataAdicional').then(function(docAd) {
							docAd = validaDataAdicional(docAd, idUsu,idAct);
							docAd.cuerpo[idUsu].acts[idAct].tachado=1;
							docAd.cuerpo[idUsu].acts[idAct].comentario.push({
								fechaRegISO:moment().format('YYYY-MM-DD HH:mm'),
								fechaRegInteger:moment().format('YYYYMMDDHHmm'),
								comen:nomUsu+': tacho la actividad.'	
							});
						  	return db.put({
								_id:'dataAdicional',
								_rev: docAd._rev,
								cuerpo:docAd.cuerpo
							});
						}).then(function(response) {
							$(elementActPadre).attr('tachado','1');
							cargarVariablesDesdeDB();
						})
						.catch(function (err) {alert(err);});
					})
					.catch(function (err) {alert(err);})
				});
				$("#cuerpoActividades").on("click",".actividad .menuAct .opciones .opcion[accion='2']", function() {
					var elementAct = this;
					var elementActPadre = $(elementAct).closest( ".actividad" );
					var idAct = $(elementActPadre).attr('id');
					FORM.idActActual = idAct;
					db.get('dataPersonal').then(function(doc) {
						if(validaDataPersonal(doc)==false)return false;
						doc=validaDataPersonal(doc);
						var idUsu = doc.cuerpo.dataUsu.idUsu;
						var nomUsu = doc.cuerpo.dataUsu.nomUsu;
						db.get('dataAdicional').then(function(docAd) {
							var comentarios=[];
							for (var usuario in docAd.cuerpo){
								if(usuario != 0){
									docAd = validaDataAdicional(docAd, usuario, FORM.idActActual);
									datActAdici = docAd.cuerpo[usuario].acts[FORM.idActActual];
									$.each(datActAdici.comentario, function( index, comen ) {
										comentarios.push(comen);
									});
								} 
							}
							
							comentarios = _.sortBy(comentarios, 'fechaRegInteger');
							comentarios.reverse();
							$('#modalComentario .historico').html('');
							$.each(comentarios, function( index, comen ) {
								$('#modalComentario .historico').append(
									'<div class="form-group">'+
									comen.comen+'<br>'+
									'<spam style="font-size:0.8em;"><b>'+
									moment(comen.fechaRegISO).format("dddd D MMMM  YYYY HH:mm")+
									'</b></spam>'+
									'</div>'
								);
							});
							$('#modalComentario').modal();
						}).then(function(response) {})
						.catch(function (err) {alert(err);});
					})
					.catch(function (err) {alert(err);})
				});
				$("#cuerpoActividades").on("click",".actividad .menuAct .opciones .opcion[accion='3']", function() {
					var elementAct = this;
					var elementActPadre = $(elementAct).closest( ".actividad" );
					var idAct = $(elementActPadre).attr('id');
					FORM.idActActual = idAct;
					var notaTotal = elementActPadre.find('.notaTotal').text();
					var notaActual = elementActPadre.find('.nuevaNota').attr('val');
					console.log(notaActual);
					if(notaActual==undefined)notaActual=0;
					if(notaTotal==undefined)notaTotal=0;
					$('#modalNota .notaTotal').text(notaTotal);
					$('#modalNota #nuevaNota').val(notaActual);
					$('#modalNota').modal();
				});
				$("#cuerpoActividades").on("click",".actividad .menuAct .opciones .opcion[accion='4']", function() {
					var elementAct = this;
					var elementActPadre = $(elementAct).closest( ".actividad" );
					var idAct = $(elementActPadre).attr('id');
					db.get('dataPersonal').then(function(doc) {
						if(validaDataPersonal(doc)==false)return false;
						doc=validaDataPersonal(doc);
						var idUsu = doc.cuerpo.dataUsu.idUsu;
						var nomUsu = doc.cuerpo.dataUsu.nomUsu;
						db.get('dataAdicional').then(function(docAd) {
							docAd = validaDataAdicional(docAd, idUsu, idAct);
							docAd.cuerpo[idUsu].acts[idAct].tachado=0;
							
							
							docAd.cuerpo[idUsu].acts[idAct].comentario.push({
								fechaRegISO:moment().format('YYYY-MM-DD HH:mm'),
								fechaRegInteger:moment().format('YYYYMMDDHHmm'),
								comen:nomUsu+': quito tachado la actividad.'	
							});
						  	return db.put({
								_id:'dataAdicional',
								_rev: docAd._rev,
								cuerpo:docAd.cuerpo
							});
						}).then(function(response) {
							$(elementActPadre).attr('tachado','0');
							cargarVariablesDesdeDB();
						})
						.catch(function (err) {alert(err);});
					})
					.catch(function (err) {alert(err);})
				});
				utilidades.log_('Elementos programados.<br>');
				function iniciarContadorTime(){
					setInterval(function(){ajustarCronometros()}, 2500);
				}
				function ajustarCronometros(){
					$.each(FORM.dataPrin.actividades, function( index, act ) {
						var msg='';
						var now = moment().format('YYYY-MM-DD HH:mm:ss');
						var nSegs=moment(act.fecFinISO+" 23:59:59").diff(moment(), 's', true);
						var nDias=moment(act.fecFinISO+" 23:59:59").diff(moment(), 'd');
						if(nDias>5)cierre=1;//Verde
						if(nDias<=5)cierre=2;//Naranja
						if(nDias<=2)cierre=3;//Rojo
						if(nDias<=0)cierre=0;//Negro
						if(nSegs<0)msg_='Cerro hace: ';
						else msg_='Cierra en: ';
						msg+=msg_+' '+moment(now).preciseDiff(act.fecFinISO+" 23:59:59");
						$('#cuerpoActividades .actividad[i="'+index+'"] .tiempoCierre').html(msg);
						$('#cuerpoActividades .actividad[i="'+index+'"] .tiempoCierre').attr('cierre',cierre);
					});
				}
				function validaDataAdicional(Data,idUsu,idAct){
					if(Data==undefined || Data==null)Data={};
					if(Data.cuerpo==undefined || Data.cuerpo==null)Data.cuerpo={};
					if(Data.cuerpo[idUsu]==undefined)Data.cuerpo[idUsu]={acts:{}};
					if(Data.cuerpo[idUsu].acts==undefined)Data.cuerpo[idUsu].acts={};
					if(idAct!=undefined){
						if(Data.cuerpo[idUsu].acts[idAct]==undefined)Data.cuerpo[idUsu].acts[idAct]={};
						if(Data.cuerpo[idUsu].acts[idAct].comentario==undefined)Data.cuerpo[idUsu].acts[idAct].comentario=[];
					}
					return Data;
				}
				function validaDataPersonal(Data, alert_){
					if(alert_==undefined)alert_=1;
					var e=0;
					if(Data.cuerpo==undefined)Data.cuerpo={};
					if(Data.cuerpo.dataUsu==undefined)Data.cuerpo.dataUsu={};
					if(typeof(Data.cuerpo.dataUsu)=='undefined')e++;
					else if($.trim(Data.cuerpo.dataUsu.idUsu)=='' || $.trim(Data.cuerpo.dataUsu.nomUsu)=='')e++;
					if(e>0 && alert_==1){
						alert('Lo sentimos pero antes de poder registrar movimientos debes configurar la app, esto con el fin de un buen desempeño.');
						$('li.configurar').click();
						return false;
					}
					return Data;
				}
				function renderizarActividades(data){
					db.get('dataPersonal').then(function(doc) {
						if(validaDataPersonal(doc, 1)==false)return false;
						doc=validaDataPersonal(doc, 0); 
						var idUsu = doc.cuerpo.dataUsu.idUsu;
						var nomUsu = doc.cuerpo.dataUsu.nomUsu;
						db.get('dataAdicional').then(function(docAd) {
							$('#cuerpoActividades').html('');
							moment.locale('es');
							var i=0;
							$.each(data, function( index, act ) {
								var idGenAct = act.ofer18curso+'-'+act.ofer18idactividad+'-'+act.ofer18fase;
								curso=_.where(FORM.dataPrin.cursos, {unad40id: act.ofer18curso});
								var tachado=0;
								var nota=0;
								
								try{
									docAd = validaDataAdicional(docAd, idUsu, idGenAct);
    								datActAdici = docAd.cuerpo[idUsu].acts[idGenAct];
    								tachado=datActAdici.tachado;
    								nota=datActAdici.notaObtenida;
    							}catch(e){
    								tachado=undefined;
    								nota=undefined;
    							}
    							var comentarios=[];
								for (var usuario in docAd.cuerpo){
									if(usuario != idUsu && usuario!=0){
										try{
											docAd = validaDataAdicional(docAd, usuario, idGenAct);
		    								datActAdici = docAd.cuerpo[usuario].acts[idGenAct];
		    								if(tachado==undefined)
		    									if(datActAdici.tachado!=undefined)tachado=datActAdici.tachado;
		    								if(nota!=undefined)
		    									if(datActAdici.notaObtenida!=undefined)nota=datActAdici.notaObtenida;
		    							}catch(e){
		    								tachado=undefined;
		    								nota=undefined;
		    							}
	    							}	
	    							if(datActAdici!=undefined){
	    								if(datActAdici.comentario.length>0){
			    							$.each(datActAdici.comentario, function( index, comen ) {
												comentarios.push(comen);
											});
										}
									} 	
								}
								if(tachado==undefined)tachado==0;
								if(nota==undefined)nota=0;
								comentarios = _.sortBy(comentarios, 'fechaRegInteger');
								comentarios.reverse();
								var comen = comentarios[0];
								var ultComen='';
								if(comen!=undefined){
									ultComen=
									'<div class="col-sm-12 ultComen" style="border-top:1px solid #ccc;border-bottom:1px solid #ccc;">'+
									'<spam style="font-size:0.8em;"><b>'+
									moment(comen.fechaRegISO).format("dddd D MMMM  YYYY HH:mm")+
									'</b></spam> '+
									comen.comen+
									'</div>';
								}
								html='';
								html+='<div class="col-sm-12 actividad" i='+index+' id='+idGenAct+' tachado='+tachado+'>';
								html+='<div class="col-sm-12 titulo">';
								html+='<spam class="glyphicon glyphicon-th pull-right menuAct"></spam>';
								html+='<spam class="pull-left">'+(index+1)+')</spam> '+curso[0].unad40nombre+' ('+act.ofer18curso+'A_'+act.ofer18per_aca+')<br>';
								html+=act.ofer04nombre;
								html+='</div>';
								html+='<div class="col-sm-12">';
								html+='Del '+moment(act.fecIniISO).format("dddd D MMMM  YYYY")+' al '+moment(act.fecFinISO).format("dddd D MMMM  YYYY");
								html+='</div>';
								html+='<div class="col-sm-offset-1 col-sm-10 col-xs-offset-1 col-xs-10 descripcion">';
								html+=act.ofer04detalle;
								html+='</div>';
								html+='<div class="col-sm-12 calificacion">';
								html+='Calificacion <spam class="nuevaNota" val="'+nota+'">'+nota+' ('+accounting.formatNumber((nota*100)/act.ofer18peso,2)+'%)</spam> de ';
								html+='<spam class="notaTotal">'+act.ofer18peso+'</spam>';
								html+='</div>';
								html+=ultComen;
								html+='<div class="col-sm-12 tiempoCierre" cierre="">';
								html+='</div>';
								html+='</div>';
								$('#cuerpoActividades').append(html);
								i++;
							});
							if(i==0){
								$('#cuerpoActividades').append('<h3>No se encuentran actividades. Vaya al menu superior Sincronizar con UNAD.</h3>');
							}
							ajustarCronometros();
							iniciarContadorTime();
							$('li.actSinCerrar').click();
						}).then(function(response) {})
						.catch(function (err) {alert(err);});
					}).then(function(response) {})
					.catch(function (err) {alert(err);});
				};
				function cargarActividadesOrderFecha(){
					FORM.dataPrin.actividades = _.sortBy(FORM.dataPrin.actividades, 'fecFinNumeric');
					renderizarActividades(FORM.dataPrin.actividades);
					$('li.actSinCerrar').click();
				};
				function estructuraDocumentos(){
					db.put({_id: 'dataAdicional'})
					.then(function (response) {
						db.put({_id: 'dataPersonal'})
						.then(function (response) {
							db.put({_id: 'dataUnad'})
							.then(function (response) {primerIngreso();})
							.catch(function (err) {console.log(err);cargarVariablesDesdeDB()});
						})
						.catch(function (err) {console.log(err);cargarVariablesDesdeDB()});
					})
					.catch(function (err) {console.log(err);cargarVariablesDesdeDB()});
				}
				function cargarVariablesDesdeDB(){
					db.get('dataUnad').then(function(doc) {
						try{
							FORM.dataPrin.cursos=doc.cuerpo[0][3];
							FORM.dataPrin.actividades=doc.cuerpo[0][2];
							cargarActividadesOrderFecha();
						}catch(e){};
					}).then(function(response) {utilidades.log_('Data Cargada a FORM.<br>');})
						.catch(function (err) {alert(err);
					})
				}
				function primerIngreso(){
					alert("Bienvenido a SUA UNAD. \nEs tu primer ingreso la app se sincronizara automaticamente.");
					db.get('dataPersonal').then(function(doc) {
						if(doc.cuerpo==undefined)doc.cuerpo={};
						var nomUsu = prompt("Ingresa tu nombre y apellido.");
						var nomUnad = prompt("Ingresa tu nombre de usuario UNAD.");
						var idUsu = prompt("Ingresa el numero de documento de identidad de "+nomUsu);
						doc.cuerpo.dataUsu={
							nomUsu:nomUsu,
							idUsu:idUsu,
							nomUnad:nomUnad
						};
					  	return db.put({
							_id:'dataPersonal',
							_rev: doc._rev,
							cuerpo:doc.cuerpo
						});
					}).then(function(response) {
						$('li.enviarRecibir').click();
					})
					.catch(function (err) {alert(err);})
				}
				$('#modalAyuda').on('shown.bs.modal', function () {
					$('#myInput').focus();
				})
				utilidades.log_('Funciones Definidas.<br>');
				estructuraDocumentos();
				utilidades.log_('Finaliza carga.<br>');
				utilidades.cierraCargador();
			});
		</script>  		
	</body>
</html>
