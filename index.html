<!DOCTYPE html>
<html>
	<head>
  		<meta charset="utf-8">
  		<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
	  	<meta name="apple-mobile-web-app-capable" content="yes">
  		<meta name="apple-mobile-web-app-status-bar-style" content="black">
  		<title>SUA UNAD</title>
  		<link rel="stylesheet" href="css/index.css?7">
  		<!-- Extra Codiqa features -->
  		<script src="js/jquery-1.9.1.min.js"></script>
  		<script src="bootstrap-3.3.5-dist/js/bootstrap.min.js"></script>
  		<script type="text/javascript" src="js/underscore-min.js"></script>
  		<script type="text/javascript" src="js/moment.min.js"></script>
  		<script type="text/javascript" src="js/readable-range.js"></script>
  		<script type="text/javascript" src="js/indexeddbshim.min.js"></script>
  		<script type="text/javascript" src="js/pouchdb-4.0.0.min.js"></script>
  		<script type="text/javascript" src="js/momentJS_espanol.js"></script>
  		<script type="text/javascript" src="js/accounting.min.js"></script>
  		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="bootstrap-3.3.5-dist/css/bootstrap.min.css">
		<!-- Latest compiled and minified JavaScript -->
		<!-- Material Design-->
		<link rel="stylesheet" href="css/material.min.css">
		<script src="js/material.min.js"></script>
		<link rel="stylesheet" href="css/fontGoogleApis.css">

		<style>
			.menuActOptions{
				background: white;
				border: 1px solid #ccc;
				bottom: 0;
				display: none;
				position: absolute;
				right: 0;
				z-index: 99;
				width: 50%;
			}
			.menuActOptions ul, .menuActOptions li{
				opacity: 1!important;
				position: relative!important;
				z-index: 9999!important;
			}
			.contenedoresActividades .actividad{
				margin: 2em 0;
				padding: 8px 4px;
				border: 1.5px solid #DDA877;
			}
			.contenedoresActividades .actividad[tachado="1"] div{
				display: none;
			}
			.contenedoresActividades .actividad[tachado="1"] .titulo{
				display: inherit!important;
				text-decoration: line-through;
			}
			.contenedoresActividades .actividad[tachado="1"] .calificacion,
			.contenedoresActividades .actividad[tachado="1"] .ultComen,
			.contenedoresActividades .actividad[tachado="1"] .tiempoCierre{
				display: inherit!important;
			}
			.contenedoresActividades .actividad[activa="1"] .titulo{
				background: #9CA8CF;
			}
			.contenedoresActividades .actividad .titulo{
				background: rgb(217, 224, 234);
				border-bottom: 1px solid #cccccc;
				font-weight: bold;
				text-align:center;
			}
			.contenedoresActividades .actividad .tiempoCierre{
				color: white;
				height: 2em;
				margin-top:10px;
				overflow: hidden;
				text-align: center;
			}
			.contenedoresActividades .actividad .descripcion{
				border:1px solid #ccc;
				margin-bottom:3px;
				margin-top:3px;
				padding:5px;
			}
			.contenedoresActividades .actividad .menuAct{
				display: inherit!important;
				font-size: 1.5em;
				padding:5px;
				position: relative;
			}
			.contenedoresActividades .actividad .menuAct .opciones{
				display: inherit!important;
				font-size: 1.5rem;
				background: white;
				border-radius: 0 0 8px 8px;
				border: 1px solid #ccc;
			  	box-shadow: -5px 0px 7px #ccc;
			  	-moz-box-shadow: -5px 0px 7px #ccc;
			  	-webkit-box-shadow: -5px 0px 7px #ccc;
				padding: 7px;
			    position: absolute;
			    text-align: right;
    			right: 5px;
    			top: 1.5em;
    			z-index: 2;
			}
			.contenedoresActividades .actividad .menuAct .opciones .opcion{
				display: inherit!important;
				padding: 10px 17px;
				border-bottom: 1px solid #ccc;
			}
			.contenedoresActividades .actividad .tiempoCierre[cierre="1"]{
				background: #095509;
			}
			.contenedoresActividades .actividad .tiempoCierre[cierre="0"]{
				background: black;
			}
			.contenedoresActividades .actividad .tiempoCierre[cierre="2"]{
				background: orange;
			}
			.contenedoresActividades .actividad .tiempoCierre[cierre="3"]{
				background: #A50000;
			}
			#Cortina{
				background: rgba(255, 255, 255, 0.58);
				left:0;
				font-size: 2em;
				position:absolute;
				text-align: center;
				font-weight: bold;
				top:0;
				z-index: 9999;
			}
			#Cortina[st="0"]{
				display: none;
				height:0;
				margin : 0;
				overflow: hidden;
				padding:0 ;
				width:0;
			}
			#Cortina[st="1"]{
				display: ;
				height:100%;
				margin : 0;
				overflow: hidden;
				padding:5em 1em;
				width:100%;
			}
		</style>
	</head>
	<body>
		<!-- Simple header with scrollable tabs. -->
		<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
			<header class="mdl-layout__header">
				<div class="mdl-layout__header-row">
					<!-- Title -->
					<span class="mdl-layout-title">SUA UNAD</span>
				</div>
				<!-- Tabs -->
				<div class="mdl-layout__tab-bar mdl-js-ripple-effect titulosCursos">
					<a href="#scroll-tab-1" class="mdl-layout__tab"></a>
					<a href="#scroll-tab-2" class="mdl-layout__tab"></a>
					<a href="#scroll-tab-3" class="mdl-layout__tab"></a>
					<a href="#scroll-tab-4" class="mdl-layout__tab"></a>
					<a href="#scroll-tab-5" class="mdl-layout__tab"></a>
					<a href="#scroll-tab-6" class="mdl-layout__tab"></a>
					<a href="#scroll-tab-7" class="mdl-layout__tab"></a>
					<a href="#scroll-tab-8" class="mdl-layout__tab"></a>
					<a href="#scroll-tab-9" class="mdl-layout__tab"></a>
					<a href="#scroll-tab-10" class="mdl-layout__tab"></a>
					<a href="#scroll-tab-11" class="mdl-layout__tab"></a>
					<a href="#scroll-tab-12" class="mdl-layout__tab"></a>
					<a href="#scroll-tab-13" class="mdl-layout__tab"></a>
					<a href="#scroll-tab-14" class="mdl-layout__tab"></a>
					<a href="#scroll-tab-15" class="mdl-layout__tab"></a>
					<a href="#scroll-tab-16" class="mdl-layout__tab"></a>
					<a href="#scroll-tab-17" class="mdl-layout__tab"></a>
					<a href="#scroll-tab-18" class="mdl-layout__tab"></a>
					<a href="#scroll-tab-19" class="mdl-layout__tab"></a>
					<a href="#scroll-tab-20" class="mdl-layout__tab"></a>
					<a href="#scroll-tab-21" class="mdl-layout__tab"></a>
					<a href="#scroll-tab-22" class="mdl-layout__tab"></a>
				</div>
			</header>
			<div class="mdl-layout__drawer">
				<span class="mdl-layout-title" style="padding: 1em 0; margin: 0; text-align: center; background: #a94442;">
						<img src="images/icon.png">
						<div class="nomUnad" style="padding: 0.5em 0 0 0; color: white"></div>
				</span>
				<ul class="demo-list-icon mdl-list">
					<li class="mdl-list__item">
						<span class="mdl-list__item-primary-content">
							<i class="material-icons mdl-list__item-icon">sync</i>
							<a class="mdl-navigation__link enviarRecibir" href="">Sincronizar</a>
						</span>
					</li>
					<li class="mdl-list__item"  style="display: none;">
						<span class="mdl-list__item-primary-content">
							<i class="material-icons mdl-list__item-icon">refresh</i>
							<a class="mdl-navigation__link recargar" href=""  onclick="window.location=''">Recargar</a>
						</span>
					</li>
					<li class="mdl-list__item">
						<span class="mdl-list__item-primary-content">
							<i class="material-icons mdl-list__item-icon">face</i>
							<a class="mdl-navigation__link configurar" href="">Usuario</a>
						</span>
					</li>
					<li class="mdl-list__item">
						<span class="mdl-list__item-primary-content">
							<i class="material-icons mdl-list__item-icon">delete forever</i>
							<a class="mdl-navigation__link borrarBD" href="">Limpiar BD</a>
						</span>
					</li>
					<li class="mdl-list__item">
						<span class="mdl-list__item-primary-content">
							<i class="material-icons mdl-list__item-icon">help</i>
							<a class="mdl-navigation__link ayuda" href=""onclick="$('#modalAyuda').modal();">Ayuda</a>
						</span>
					</li>
					<li class="mdl-list__item">
						<span class="mdl-list__item-primary-content" style="font-size: 14px;font-weight: 400; color: #424242;">
						  	Actividades Abiertas
						</span>
						<span class="mdl-list__item-secondary-action">
							<label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="act_switch_abiertas">
								<input type="checkbox" id="act_switch_abiertas" class="mdl-switch__input" checked>
							</label>
						</span>
					</li>
					<li class="mdl-list__item">
						<span class="mdl-list__item-primary-content" style="font-size: 14px;font-weight: 400; color: #424242;">
						  	Actividades Cerradas
						</span>
						<span class="mdl-list__item-secondary-action">
							<label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="act_switch_cerradas">
								<input type="checkbox" id="act_switch_cerradas" class="mdl-switch__input">
							</label>
						</span>
					</li>
				</ul>
			</div>

			<main class="mdl-layout__content contenedoresActividades">
			</main>
			<div style="position:absolute; z-index: 99999;" class="menuActOptions">
				<span class="titleActSelect"></span>
				<ul class="mdl-menu mdl-menu--bottom-left opciones">
					<li class="mdl-menu__item mdl-menu__item--full-bleed-divider opcion" accion="1" style="opacity: 1!important;">Tachar</li>
					<li class="mdl-menu__item mdl-menu__item--full-bleed-divider opcion" accion="4">Quitar Tachado</li>
					<li class="mdl-menu__item mdl-menu__item--full-bleed-divider opcion" accion="2">Comentarios</li>
					<li class="mdl-menu__item mdl-menu__item--full-bleed-divider opcion" accion="3">Nota</li>
				</ul>
			</div>
		</div>
  		<div id="Cortina">CARGANDO</div>
  		<div class="modal fade" id="modalAyuda">
		  	<div class="modal-dialog">
			    <div class="modal-content">
			      	<div class="modal-header">
		        		<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		        		<h4 class="modal-title">Bienvedido a SUA UNAD</h4>
	      			</div>
		      		<div class="modal-body">
		        		<p>SUA UNAD es una aplicacion desarrollada para la gesti&oacute;n de actividades acad&eacute;micas.</p>
		        		<p>SUA UNAD tiene las siguientes opciones:</p>
		        		<ul>
		        			<li>
		        				<b>Menú Superior(SUA UNAD):</b> En el encontraras opciones generales como:
		        				<ul>
		        					<li>Sincronizar: Sincroniza la app con la base de datos dela UNAD. Recomdable hacerlo una vez a la semana.</il>
		        					<li>Recargar: Actualizara la app.</il>
		        				</ul>
		        				<b>Menú Inferior(HERRAMIENTAS):</b> En el encontrara herramientas como:
		        				<ul>
		        					<li>Actividades Cerradas: Todas las actividades que ya han sido cerradas.</il>
		        					<li>Actividades Sin Cerrar: Todas las actividades que a&uacute;n no han sido cerradas.</il>
		        					<li>Todas las Actividades: Todas las actividades cerradas y no cerradas.</il>
		        				</ul>
		        			</il>
		        		</ul>
		        		<div style="font-weight: bold;font-size: 0.9em; margin:15px 0; text-align: right;" >
		        			Desarrollada por oscarricardosan@gmail.com
		        		</div>
		      		</div>
		      		<div class="modal-footer">
		        		<button type="button" class="btn btn-default" data-dismiss="modal">Entendido</button>
		      		</div>
		    	</div><!-- /.modal-content -->
		  	</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
		<div class="modal fade" id="modalLog">
		  	<div class="modal-dialog">
			    <div class="modal-content">
			      	<div class="modal-header">
		        		<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		        		<h4 class="modal-title">Log</h4>
	      			</div>
		      		<div class="modal-body">
		        		<div class="cuerpo" ></div>
		      		</div>
		      		<div class="modal-footer">
		        		<button type="button" class="btn btn-default" data-dismiss="modal">Salir</button>
		      		</div>
		    	</div><!-- /.modal-content -->
		  	</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->

		<div class="modal fade" id="modalConfiguracion">
		  	<div class="modal-dialog">
			    <div class="modal-content">
			      	<div class="modal-header">
		        		<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		        		<h4 class="modal-title">Configuracion</h4>
	      			</div>
		      		<div class="modal-body">
		      			<p>
		      				Los datos suministrados en ning&uacute;n momento ser&aacute;n entregados y/o usados por terceros.
							Son datos que habilitan la funcionalidad de almacenar comentarios, notas y dem&aacute;s.
		      			</p>
						<div class="form-group" style="display: none">
					    	<label>Documento de Identidad (cedula, tarjeta de identidad, etc..)</label>
					    	<input class="form-control" id="idUsu">
					  	</div>
					  	<div class="form-group">
					    	<label>Nombre de usuario UNAD</label>
					    	<input class="form-control" id="nomUnad">
					  	</div>
					  	<div class="form-group" style="display: none">
					    	<label>Nombre para mostrar</label>
					    	<input class="form-control" id="nombre">
					  	</div>

		      		</div>
		      		<div class="modal-footer">
		      			<button type="button" class="btn btn-default guardar" data-dismiss="modal">Guardar</button>
		        		<button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
		      		</div>
		    	</div><!-- /.modal-content -->
		  	</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
		<div class="modal fade" id="modalNota">
		  	<div class="modal-dialog">
			    <div class="modal-content">
			      	<div class="modal-header">
		        		<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		        		<h4 class="modal-title">Nota</h4>
	      			</div>
		      		<div class="modal-body">
		        		<div class="form-group">
					    	<label>Nota de la actividad</label>
				    		<input class="form-control" id="nuevaNota">
				    		<label>Sobre <span class="notaTotal"></span></label>
					  	</div>
		      		</div>
		      		<div class="modal-footer">
		      			<button type="button" class="btn btn-default guardar" data-dismiss="modal">Guardar</button>
		        		<button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
		      		</div>
		    	</div><!-- /.modal-content -->
		  	</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
		<div class="modal fade" id="modalComentario">
		  	<div class="modal-dialog">
			    <div class="modal-content">
			      	<div class="modal-header">
		        		<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		        		<h4 class="modal-title">Comentarios</h4>
	      			</div>
		      		<div class="modal-body">
		        		<div class="form-group">
					    	<label>Ingrese Comentario</label>
					    	<textArea class="form-control" id="comentario"></textArea>
					  	</div>
					  	<div class="historico" style="height: 20em; overflow: auto"></div>
		      		</div>
		      		<div class="modal-footer">
		      			<button type="button" class="btn btn-default guardar" data-dismiss="modal">Registrar Nuevo Comentario</button>
		        		<button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
		      		</div>
		    	</div><!-- /.modal-content -->
		  	</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->

		<script>
			var utilidades = {
				abreCargador:function(){$('#Cortina').attr('st','1')},
				cierraCargador:function(){$('#Cortina').attr('st','0')},
				log_: function(msg){$('#modalLog .cuerpo').append(msg);}
			}
			utilidades.abreCargador();
			$(document).ready(function(){
				var FORM={
					dataPrin:{},
					clickkMenuAct:0
				};
				var nameDB = 'SUA_UNAD';
				var db = new PouchDB(nameDB);
				var remoteCouch = false;
				utilidades.log_('Utilidades cargadas.<br>');
				$('body').click(function(){
					if(FORM.clickkMenuAct != 1){
						$('.menuActOptions').css('display','none');
						desactivarActividades();
					}
					FORM.clickkMenuAct = 0;
				});
				$('main').scroll(function(){
					if(FORM.clickkMenuAct != 1){
						$('.menuActOptions').css('display','none');
						desactivarActividades();
					}
					FORM.clickkMenuAct = 0;
				});
				$('body').mouseup(function(){
					if(FORM.clickkMenuAct != 1){
						$('.menuActOptions').css('display','none');
						desactivarActividades();
					}
					FORM.clickkMenuAct = 0;
				});
				$('a.configurar').click(function(){
					utilidades.cierraCargador();
					$('#modalConfiguracion').modal();
					db.get('dataPersonal').then(function(doc) {
						doc=validaDataPersonal(doc, 0);
						if(typeof(doc.cuerpo.dataUsu)=='undefined')return false;
						$('#modalConfiguracion #nomUnad').val(doc.cuerpo.dataUsu.nomUnad);
						$('#modalConfiguracion #nombre').val(doc.cuerpo.dataUsu.nomUsu);
						$('#modalConfiguracion #idUsu').val(doc.cuerpo.dataUsu.idUsu);
					}).then(function(response) {
						utilidades.log_('dataP obtenida.<br>');
					})
					.catch(function (err) {alert(err);})
				});
				$('#modalConfiguracion .guardar').click(function(event){
					event.preventDefault();
					db.get('dataPersonal').then(function(doc) {
						utilidades.log_('dataP obtenida.<br>');
						if(doc.cuerpo==undefined)doc.cuerpo={};
						doc.cuerpo.dataUsu={
							nomUsu:$('#modalConfiguracion #nombre').val(),
							idUsu:$('#modalConfiguracion #idUsu').val(),
							nomUnad:$('#modalConfiguracion #nomUnad').val(),
						};
					  	return db.put({
							_id:'dataPersonal',
							_rev: doc._rev,
							cuerpo:doc.cuerpo
						});
					}).then(function(response) {
						utilidades.log_('Se guarda data.<br>');
						alert('Datos Guardados');
					})
					.catch(function (err) {alert(err);})
				});
				$('#modalNota .guardar').click(function(event){
					var idAct = FORM.idActActual;
					var nuevaNota = $('#modalNota #nuevaNota').val();
					var notaTot = $('#modalNota .notaTotal').text();
					db.get('dataPersonal').then(function(doc) {
						if(validaDataPersonal(doc)==false)return false;
						doc=validaDataPersonal(doc);
						var idUsu = doc.cuerpo.dataUsu.idUsu;
						var nomUsu = doc.cuerpo.dataUsu.nomUsu;
						db.get('dataAdicional').then(function(docAd) {
							docAd = validaDataAdicional(docAd, idUsu,idAct);
							docAd.cuerpo[idUsu].acts[idAct].notaObtenida=nuevaNota;
							docAd.cuerpo[idUsu].acts[idAct].comentario.push({
								fechaRegISO:moment().format('YYYY-MM-DD HH:mm'),
								fechaRegInteger:moment().format('YYYYMMDDHHmm'),
								comen:nomUsu+': nota actualizada a '+nuevaNota+'.'
							});
						  	return db.put({
								_id:'dataAdicional',
								_rev: docAd._rev,
								cuerpo:docAd.cuerpo
							});
						}).then(function(response) {
							cargarVariablesDesdeDB();
							$('div.actividad[id="'+idAct+'"]').find('.nuevaNota')
							.text(' '+nuevaNota+' ('+accounting.formatNumber((nuevaNota*100)/notaTot,2)+'%)');
						})
						.catch(function (err) {alert(err);});
					})
					.catch(function (err) {alert(err);})
				});
				$('#modalComentario .guardar').click(function(event){
					var idAct = FORM.idActActual;
					db.get('dataPersonal').then(function(doc) {
						if(validaDataPersonal(doc)==false)return false;
						doc=validaDataPersonal(doc);
						var idUsu = doc.cuerpo.dataUsu.idUsu;
						var nomUsu = doc.cuerpo.dataUsu.nomUsu;
						db.get('dataAdicional').then(function(docAd) {
							docAd = validaDataAdicional(docAd, idUsu,idAct);
							docAd.cuerpo[idUsu].acts[idAct].comentario.push({
								fechaRegISO:moment().format('YYYY-MM-DD HH:mm'),
								fechaRegInteger:moment().format('YYYYMMDDHHmm'),
								comen:nomUsu+': '+$('#modalComentario #comentario').val()
							});
						  	return db.put({
								_id:'dataAdicional',
								_rev: docAd._rev,
								cuerpo:docAd.cuerpo
							});
						}).then(function(response) {
							$('#modalComentario #comentario').val('');
							$(".contenedoresActividades .actividad .menuAct .opciones .opcion[accion='2']").click();
							cargarVariablesDesdeDB();
						})
						.catch(function (err) {alert(err);});
					})
					.catch(function (err) {alert(err);})
				});
				$('a.borrarBD').click(function(){
					var r = confirm("Con esta accion va a eliminar la Base de Datos(BD).\nEsta seguro?, esta acción es irreversible.\nAceptar(Si)");
					if (r == true) {
					    db.destroy();
					    alert('Base de datos eliminada');
						window.location='';
					}
				});
				$('a.verLog').click(function(){
					$('#modalLog').modal();
				});
				$('a.enviarRecibir').click(function(){
					utilidades.abreCargador();
					var idAct = FORM.idActActual;
					db.get('dataPersonal').then(function(doc) {
						if(validaDataPersonal(doc)==false)return false;
						doc=validaDataPersonal(doc);
						var idUsu = doc.cuerpo.dataUsu.idUsu;
						var nomUsu = doc.cuerpo.dataUsu.nomUsu;
						var nomUnad = doc.cuerpo.dataUsu.nomUnad;
						var url ="https://savne.net/sua/actividades/"+nomUnad+"";
						var claveUsu = prompt(nomUnad+" ingresa tu clave de la plataforma UNAD.");
						if(!claveUsu || $.trim(claveUsu)==''){utilidades.cierraCargador();return false;}
						var miCahe = claveUsu;
						var lenCl = claveUsu.length;
						var c1 = Math.floor(Math.random() * lenCl-2) ;
						if(c1 <3 )c1=3;
						url =
							url+'/'+miCahe.substr(c1,lenCl)+
							'/'+(
							(moment().format('YYYY')*1)+(moment().format('MM')*1)+(moment().format('DD')*1)
							)*Math.floor(Math.random() * 10000)
						;
						if($.trim(nomUnad)=='' || $.trim(claveUsu)==''){
							cargarVariablesDesdeDB();
							cargarActividadesOrderFecha();
							utilidades.cierraCargador();
							return false;
						}
						url = url+'/'+miCahe.substr(0,c1);
						db.get('dataAdicional').then(function(docAd) {
							docAd = validaDataAdicional(docAd, idUsu);
							$.getJSON( url+'.json', function(data) {
								utilidades.log_('Data cargada<br>');
								cargarVariablesDesdeDB();
								$.each(data.actividades[2], function( index, act ) {
									if(act.diaini<10)act.diaini='0'+act.diaini;
									if(act.diafin<10)act.diafin='0'+act.diafin;
									if(act.mesini<10)act.mesini='0'+act.mesini;
									if(act.mesfin<10)act.mesfin='0'+act.mesfin;
									if(act.agnoini<10)act.agnoini='0'+act.agnoini;
									if(act.agnofin<10)act.agnofin='0'+act.agnofin;
									act.fecIni = act.diaini+'/'+act.mesini+'/'+act.agnoini;
									act.fecFin = act.diafin+'/'+act.mesfin+'/'+act.agnofin;
									act.fecIniISO = act.agnoini+'-'+act.mesini+'-'+act.diaini;
									act.fecFinISO = act.agnofin+'-'+act.mesfin+'-'+act.diafin;
									act.fecIniNumeric = parseInt(act.agnoini+''+act.mesini+''+act.diaini);
									act.fecFinNumeric = parseInt(act.agnofin+''+act.mesfin+''+act.diafin);
								});
								db.get('dataUnad').then(function(doc) {
									return db.put({
										_id:'dataUnad',
										_rev: doc._rev,
										cuerpo:data
									});
								}).then(function(response) {
									alert('Sincronizacion Exitosa.');
									window.location='';
									cargarVariablesDesdeDB();
									cargarActividadesOrderFecha();
									utilidades.cierraCargador();
								})
								.catch(function (err) {alert(err);});
							})
							.fail(function() {
								alert( "Request failed: " );
								utilidades.cierraCargador();
							});
						})
						.catch(function (err) {alert(err);});
					})
					.catch(function (err) {alert(err);})
				});
				$('#act_switch_cerradas, #act_switch_abiertas').click(function(){
					filtroStatusAct();
				});
				$("body").on("click",".actividad .menuAct", function() {
					FORM.clickkMenuAct = 1;
					desactivarActividades();
					$(this).closest('.actividad').attr('activa', '1');
					$('.menuActOptions').css('display','inline');
					$('.menuActOptions .titleActSelect').html('');
				});
				$("body").on("click",".menuActOptions .opciones .opcion[accion='1']", function() {
					var elementAct = this;
					var elementActPadre = $(".actividad[activa='1']");
					var idAct = $(elementActPadre).attr('id');
					$('.menuActOptions').css('display','none');
					db.get('dataPersonal').then(function(doc) {
						if(validaDataPersonal(doc)==false)return false;
						doc=validaDataPersonal(doc);
						var idUsu = doc.cuerpo.dataUsu.idUsu;
						var nomUsu = doc.cuerpo.dataUsu.nomUsu;
						db.get('dataAdicional').then(function(docAd) {
							docAd = validaDataAdicional(docAd, idUsu,idAct);
							docAd.cuerpo[idUsu].acts[idAct].tachado=1;
							docAd.cuerpo[idUsu].acts[idAct].comentario.push({
								fechaRegISO:moment().format('YYYY-MM-DD HH:mm'),
								fechaRegInteger:moment().format('YYYYMMDDHHmm'),
								comen:nomUsu+' tacho la actividad.'
							});
						  	return db.put({
								_id:'dataAdicional',
								_rev: docAd._rev,
								cuerpo:docAd.cuerpo
							});
						}).then(function(response) {
							$(elementActPadre).attr('tachado','1');
							cargarVariablesDesdeDB();
						})
						.catch(function (err) {alert(err);});
					})
					.catch(function (err) {alert(err);})
				});
				$("body").on("click",".menuActOptions .opciones .opcion[accion='2']", function() {
					var elementAct = this;
					var elementActPadre = $(".actividad[activa='1']");
					var idAct = $(elementActPadre).attr('id');
					FORM.idActActual = idAct;
					$('.menuActOptions').css('display','none');
					db.get('dataPersonal').then(function(doc) {
						if(validaDataPersonal(doc)==false)return false;
						doc=validaDataPersonal(doc);
						var idUsu = doc.cuerpo.dataUsu.idUsu;
						var nomUsu = doc.cuerpo.dataUsu.nomUsu;
						db.get('dataAdicional').then(function(docAd) {
							var comentarios=[];
							for (var usuario in docAd.cuerpo){
								docAd = validaDataAdicional(docAd, usuario, FORM.idActActual);
								datActAdici = docAd.cuerpo[usuario].acts[FORM.idActActual];
								$.each(datActAdici.comentario, function( index, comen ) {
									comentarios.push(comen);
								});
							}

							comentarios = _.sortBy(comentarios, 'fechaRegInteger');
							comentarios.reverse();
							$('#modalComentario .historico').html('');
							$.each(comentarios, function( index, comen ) {
								$('#modalComentario .historico').append(
									'<div class="form-group">'+
									comen.comen+'<br>'+
									'<spam style="font-size:0.8em;"><b>'+
									moment(comen.fechaRegISO).format("dddd D MMMM  YYYY HH:mm")+
									'</b></spam>'+
									'</div>'
								);
							});
							$('#modalComentario').modal();
						}).then(function(response) {})
						.catch(function (err) {alert(err);});
					})
					.catch(function (err) {alert(err);})
				});
				$("body").on("click",".menuActOptions .opciones .opcion[accion='3']", function() {
					$('.menuActOptions').css('display','none');
					var elementAct = this;
					var elementActPadre = $(".actividad[activa='1']");
					var idAct = $(elementActPadre).attr('id');
					FORM.idActActual = idAct;
					var notaTotal = elementActPadre.find('.notaTotal').text();
					var notaActual = elementActPadre.find('.nuevaNota').attr('val');
					if(notaActual==undefined)notaActual=0;
					if(notaTotal==undefined)notaTotal=0;
					$('#modalNota .notaTotal').text(notaTotal);
					$('#modalNota #nuevaNota').val(notaActual);
					$('#modalNota').modal();
				});
				$("body").on("click",".menuActOptions .opciones .opcion[accion='4']", function() {
					$('.menuActOptions').css('display','none');
					var elementAct = this;
					var elementActPadre = $(".actividad[activa='1']");
					var idAct = $(elementActPadre).attr('id');
					db.get('dataPersonal').then(function(doc) {
						if(validaDataPersonal(doc)==false)return false;
						doc=validaDataPersonal(doc);
						var idUsu = doc.cuerpo.dataUsu.idUsu;
						var nomUsu = doc.cuerpo.dataUsu.nomUsu;
						db.get('dataAdicional').then(function(docAd) {
							docAd = validaDataAdicional(docAd, idUsu, idAct);
							docAd.cuerpo[idUsu].acts[idAct].tachado=0;
							docAd.cuerpo[idUsu].acts[idAct].comentario.push({
								fechaRegISO:moment().format('YYYY-MM-DD HH:mm'),
								fechaRegInteger:moment().format('YYYYMMDDHHmm'),
								comen:nomUsu+' Se remueve tachado la actividad.'
							});
						  	return db.put({
								_id:'dataAdicional',
								_rev: docAd._rev,
								cuerpo:docAd.cuerpo
							});
						}).then(function(response) {
							$(elementActPadre).attr('tachado','0');
							cargarVariablesDesdeDB();
						})
						.catch(function (err) {alert(err);});
					})
					.catch(function (err) {alert(err);})
				});
				utilidades.log_('Elementos programados.<br>');
				function iniciarContadorTime(){
					setInterval(function(){ajustarCronometros()}, 2500);
				}
				function ajustarCronometros(){
					$.each(FORM.dataPrin.actividades, function( index, act ) {
						var msg='';
						var now = moment().format('YYYY-MM-DD HH:mm:ss');
						var nSegs=moment(act.fecFinISO+" 23:59:59").diff(moment(), 's', true);
						var nDias=moment(act.fecFinISO+" 23:59:59").diff(moment(), 'd');
						if(nDias>5)cierre=1;//Verde
						if(nDias<=5)cierre=2;//Naranja
						if(nDias<=2)cierre=3;//Rojo
						if(nDias<=0)cierre=0;//Negro
						if(nSegs<0)msg_='Cerro hace: ';
						else msg_='Cierra en: ';
						msg+=msg_+' '+moment(now).preciseDiff(act.fecFinISO+" 23:59:59");
						$('.contenedoresActividades .actividad[i="'+index+'"] .tiempoCierre').html(msg);
						$('.contenedoresActividades .actividad[i="'+index+'"] .tiempoCierre').attr('cierre',cierre);
					});
				}
				function validaDataAdicional(Data,idUsu,idAct){
					if(Data==undefined || Data==null)Data={};
					if(Data.cuerpo==undefined || Data.cuerpo==null)Data.cuerpo={};
					if(Data.cuerpo[idUsu]==undefined)Data.cuerpo[idUsu]={acts:{}};
					if(Data.cuerpo[idUsu].acts==undefined)Data.cuerpo[idUsu].acts={};
					if(idAct!=undefined){
						if(Data.cuerpo[idUsu].acts[idAct]==undefined)Data.cuerpo[idUsu].acts[idAct]={};
						if(Data.cuerpo[idUsu].acts[idAct].comentario==undefined)Data.cuerpo[idUsu].acts[idAct].comentario=[];
					}
					return Data;
				}
				function validaDataPersonal(Data, alert_){
					if(alert_==undefined)alert_=1;
					var e=0;
					if(Data.cuerpo==undefined)Data.cuerpo={};
					if(Data.cuerpo.dataUsu==undefined)Data.cuerpo.dataUsu={};
					if(typeof(Data.cuerpo.dataUsu)=='undefined')e++;
					else if($.trim(Data.cuerpo.dataUsu.nomUnad)=='')e++;
					if(e>0 && alert_==1){
						alert('Lo sentimos pero antes de poder registrar movimientos debes configurar la app, esto con el fin de un buen desempeño.');
						$('li.configurar').click();
						return false;
					}
					$('.nomUnad').html(Data.cuerpo.dataUsu.nomUnad);
					return Data;
				}
				function renderizarActividades(data){
					db.get('dataPersonal').then(function(doc) {
						if(validaDataPersonal(doc, 1)==false)return false;
						doc=validaDataPersonal(doc, 0);
						var idUsu = doc.cuerpo.dataUsu.idUsu;
						var nomUsu = doc.cuerpo.dataUsu.nomUsu;
						db.get('dataAdicional').then(function(docAd) {
							$('.contenedoresActividades #scroll-tab-1').html('');
							moment.locale('es');
							var i=0;
							$('.contenedoresActividades #scroll-tab-1').html('<ul class="demo-list-three mdl-list"></ul>');
							var htmlFinal='';
							$.each(data, function( index, act ) {
								var idGenAct = act.ofer18curso+'-'+act.ofer18idactividad+'-'+act.ofer18fase;
								curso=_.where(FORM.dataPrin.cursos, {unad40id: act.ofer18curso});
								var tachado=0;
								var nota=0;

								try{
									docAd = validaDataAdicional(docAd, idUsu, idGenAct);
    								datActAdici = docAd.cuerpo[idUsu].acts[idGenAct];
    								tachado=datActAdici.tachado;
    								nota=datActAdici.notaObtenida;
    							}catch(e){
    								tachado=undefined;
    								nota=undefined;
    							}
    							var comentarios=[];
								for (var usuario in docAd.cuerpo){
									if(usuario != idUsu && usuario!=0){
										try{
											docAd = validaDataAdicional(docAd, usuario, idGenAct);
		    								datActAdici = docAd.cuerpo[usuario].acts[idGenAct];
		    								if(tachado==undefined)
		    									if(datActAdici.tachado!=undefined)tachado=datActAdici.tachado;
		    								if(nota!=undefined)
		    									if(datActAdici.notaObtenida!=undefined)nota=datActAdici.notaObtenida;
		    							}catch(e){
		    								tachado=undefined;
		    								nota=undefined;
		    							}
	    							}
	    							if(datActAdici!=undefined){
	    								if(datActAdici.comentario.length>0){
			    							$.each(datActAdici.comentario, function( index, comen ) {
												comentarios.push(comen);
											});
										}
									}
								}
								if(tachado==undefined)tachado==0;
								if(nota==undefined)nota=0;
								comentarios = _.sortBy(comentarios, 'fechaRegInteger');
								comentarios.reverse();
								var comen = comentarios[0];
								var ultComen='';
								if(comen!=undefined){
									ultComen=
									'<div class="col-sm-12 ultComen" style="border-top:1px solid #ccc;border-bottom:1px solid #ccc;">'+
									'<spam style="font-size:0.8em;"><b>'+
									moment(comen.fechaRegISO).format("dddd D MMMM  YYYY HH:mm")+
									'</b></spam> '+
									comen.comen+
									'</div>';
								}
								html='';
								html+='<div class="col-sm-12 actividad" i='+index+' id='+idGenAct+' tachado='+tachado+' idUnad="'+curso[0].unad40id+'">';
								html+='<div class="col-sm-12 titulo">';
								html+='<spam class="glyphicon glyphicon-th pull-right menuAct"></spam>';
								html+='<spam class="pull-left">'+(index+1)+')</spam> '+curso[0].unad40nombre+' ('+act.ofer18curso+'A_'+act.ofer18per_aca+')<br>';
								html+=act.ofer04nombre;
								html+='</div>';
								html+='<div class="col-sm-12">';
								html+='Del '+moment(act.fecIniISO).format("dddd D MMMM  YYYY")+' al '+moment(act.fecFinISO).format("dddd D MMMM  YYYY");
								html+='</div>';
								html+='<div class="col-sm-offset-1 col-sm-10 col-xs-offset-1 col-xs-10 descripcion">';
								html+=act.ofer04detalle;
								html+='</div>';
								html+='<div class="col-sm-12 calificacion">';
								if(nota==undefined)nota=0;
								html+='Calificacion <spam class="nuevaNota" val="'+nota+'">'+nota+' ('+accounting.formatNumber((nota*100)/act.ofer18peso,2)+'%)</spam> de ';
								html+='<spam class="notaTotal">'+act.ofer18peso+'</spam>';
								html+='</div>';
								html+=ultComen;
								html+='<div class="col-sm-12 tiempoCierre" cierre="">';
								html+='</div>';
								html+='</div>';
								htmlFinal+=html;
								i++;
							});
							if(i==0){
								htmlFinal='<h3>No se encuentran actividades. Vaya al menu superior Sincronizar con UNAD.</h3>';
							}
							$('.contenedoresActividades #scroll-tab-1 ul').html(htmlFinal);
							ajustarCronometros();
							iniciarContadorTime();
							filtroStatusAct();
							AsignaToContenedorDeActs(FORM.dataPrin.cursos);
						}).then(function(response) {})
						.catch(function (err) {alert(err);});
					}).then(function(response) {})
					.catch(function (err) {alert(err);});
				};
				function cargarActividadesOrderFecha(){
					FORM.dataPrin.actividades = _.sortBy(FORM.dataPrin.actividades, 'fecFinNumeric');
					renderizarActividades(FORM.dataPrin.actividades);
					$('li.actSinCerrar').click();
				};
				function cargarTitleTabs(titles){
					$('.titulosCursos').html('<a href="#scroll-tab-1" class="mdl-layout__tab is-active">Todo</a>');
					$('.contenedoresActividades').html(
						'<section class="mdl-layout__tab-panel is-active" id="scroll-tab-1">'+
						'<div class="page-content">'+
						'</div>'+
						'</section>'
					);
					$.each(titles, function( index, title ) {
						var i = index +2;
						$('.titulosCursos').append(
							'<a href="#scroll-tab-'+i+'" class="mdl-layout__tab" idUnad="'+title.unad40id+'">' +
								title.unad40nombre+'('+title.unad40id+')'+
							'</a>'
						);
						$('.contenedoresActividades').append(
							'<section class="mdl-layout__tab-panel" id="scroll-tab-'+i+'" idUnad="'+title.unad40id+'">'+
							'<div class="page-content">'+
							'</div>'+
							'</section>'
						);
					});
				}
				function estructuraDocumentos(){
					db.put({_id: 'dataAdicional'})
					.then(function (response) {
						db.put({_id: 'dataPersonal'})
						.then(function (response) {
							db.put({_id: 'dataUnad'})
							.then(function (response) {primerIngreso();})
							.catch(function (err) {console.log(err);cargarVariablesDesdeDB()});
						})
						.catch(function (err) {console.log(err);});
					})
					.catch(function (err) {console.log(err);cargarVariablesDesdeDB();});
				}
				function cargarVariablesDesdeDB(){
					db.get('dataUnad').then(function(doc) {
						try{
							desactivarActividades();
							var titAct = $('.mdl-layout__tab.is-active').attr('idunad');
							FORM.dataPrin.cursos=doc.cuerpo.actividades[3];
							FORM.dataPrin.actividades=doc.cuerpo.actividades[2];
							cargarTitleTabs(FORM.dataPrin.cursos);
							cargarActividadesOrderFecha();
							console.log(titAct);
							if(titAct!='' && titAct!=null && titAct!=undefined){
								$('.mdl-layout__tab').removeClass('is-active');
								$('.mdl-layout__tab[idunad="'+titAct+'"]').click();
							}
						}catch(e){};
					}).then(function(response) {utilidades.log_('Data Cargada a FORM.<br>');})
						.catch(function (err) {alert(err);
					})
				}
				function primerIngreso(){
					alert("Bienvenido a SUA UNAD. \nEs tu primer ingreso la app se sincronizara automaticamente.");
					db.get('dataPersonal').then(function(doc) {
						if(doc.cuerpo==undefined)doc.cuerpo={};
						var nomUsu = '';
						var nomUnad = prompt("Ingresa tu nombre de usuario UNAD.");
						var idUsu = '';
						doc.cuerpo.dataUsu={
							nomUsu:nomUsu,
							idUsu:idUsu,
							nomUnad:nomUnad
						};
					  	return db.put({
							_id:'dataPersonal',
							_rev: doc._rev,
							cuerpo:doc.cuerpo
						});
					}).then(function(response) {
						$('a.enviarRecibir').click();
					})
					.catch(function (err) {alert(err);})
				}
				$('#modalAyuda').on('shown.bs.modal', function () {
					$('#myInput').focus();
				});
				$("body").on("click",".mdl-layout__tab", function() {
					$('.mdl-layout__tab').removeClass('is-active');
					$(this).addClass('is-active');
					$('section').css({
						'display': 'none',
						'height': '0',
						'width': '0',
						'overflow': 'hidden'
					});
					$('section'+$(this).attr('href')).css({
						'display': 'block',
						'height': 'auto',
						'width': 'auto',
						'overflow': 'auto'
					});;

				})
				$('a.enviarRecibir, a.recargar, a.configurar, a.borrarBD, a.ayuda').click(function(event){
					event.preventDefault();
				});
				function filtroStatusAct(){
					$('.contenedoresActividades .actividad').css('display','none');
					if($('#act_switch_cerradas').prop('checked'))
						$('.contenedoresActividades .actividad .tiempoCierre[cierre="0"]').parent().css('display','');
					if($('#act_switch_abiertas').prop('checked')){
						$('.contenedoresActividades .actividad .tiempoCierre[cierre="1"]').parent().css('display','');
						$('.contenedoresActividades .actividad .tiempoCierre[cierre="2"]').parent().css('display','');
						$('.contenedoresActividades .actividad .tiempoCierre[cierre="3"]').parent().css('display','');
					}
				}
				function AsignaToContenedorDeActs(cursos){
					$.each(cursos, function( index, curso) {
						var actividades = '';
						if($('.actividad[idUnad="'+curso.unad40id+'"]').length==0){
							$('.mdl-layout__tab[idUnad="'+curso.unad40id+'"]').css('display','none');
							$('section[idUnad="'+curso.unad40id+'"]').css('display','none');
						}
						$('.actividad[idUnad="'+curso.unad40id+'"]').each(function(){
							html = $(this).clone().wrapAll("<div/>").parent().html();
							actividades+=html;
						});
						$('section[idUnad="'+curso.unad40id+'"]').html(actividades);
					});
				}
				function desactivarActividades(){
					$('.actividad').attr('activa', '0');
				}
				utilidades.log_('Funciones Definidas.<br>');
				estructuraDocumentos();
				utilidades.log_('Finaliza carga.<br>');
				utilidades.cierraCargador();
			});
		</script>

	</body>
</html>
